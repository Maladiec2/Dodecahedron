<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ðŸ§¬ Octave Helix Spiral - Quannex Coherence Engine</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            color: #00ffcc;
            overflow: hidden;
            height: 100vh;
        }

        #canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .ui-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 20px;
            backdrop-filter: blur(10px);
            background: rgba(10, 10, 10, 0.7);
            border-bottom: 2px solid #00ffcc;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .title {
            font-size: 24px;
            font-weight: bold;
            color: #00ffcc;
            text-shadow: 0 0 10px #00ffcc;
        }

        .controls {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
            background: rgba(0, 255, 204, 0.1);
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #00ffcc;
        }

        .control-label {
            font-size: 12px;
            text-transform: uppercase;
            color: #888;
            min-width: 80px;
        }

        select, input {
            background: rgba(0, 255, 204, 0.05);
            color: #00ffcc;
            border: 1px solid #00ffcc;
            padding: 8px 10px;
            border-radius: 3px;
            font-family: monospace;
            font-size: 12px;
        }

        select:hover, input:hover {
            background: rgba(0, 255, 204, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.3);
        }

        button {
            background: rgba(0, 255, 204, 0.1);
            color: #00ffcc;
            border: 1px solid #00ffcc;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
            font-family: monospace;
            font-size: 12px;
            text-transform: uppercase;
            transition: all 0.3s ease;
        }

        button:hover {
            background: #00ffcc;
            color: #0a0a0a;
            box-shadow: 0 0 15px #00ffcc;
        }

        .info-panel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(10, 10, 10, 0.9);
            border: 2px solid #00ffcc;
            border-radius: 8px;
            padding: 20px;
            max-width: 350px;
            font-size: 12px;
            backdrop-filter: blur(10px);
        }

        .info-title {
            color: #00ffcc;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
            text-shadow: 0 0 10px #00ffcc;
        }

        .info-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid rgba(0, 255, 204, 0.2);
        }

        .info-label {
            color: #888;
        }

        .info-value {
            color: #00ffcc;
            font-weight: bold;
        }

        .octave-indicator {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(10, 10, 10, 0.9);
            border: 2px solid #00ffcc;
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(10px);
            font-size: 12px;
        }

        .octave-label {
            color: #888;
            margin-bottom: 10px;
            font-size: 10px;
            text-transform: uppercase;
        }

        .octave-circles {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            max-width: 200px;
        }

        .octave-dot {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            border: 2px solid #00ffcc;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            background: rgba(0, 255, 204, 0.1);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .octave-dot:hover {
            background: rgba(0, 255, 204, 0.3);
            box-shadow: 0 0 10px #00ffcc;
        }

        .octave-dot.active {
            background: #00ffcc;
            color: #0a0a0a;
            font-weight: bold;
            box-shadow: 0 0 15px #00ffcc;
        }

        .octave-dot.completed {
            background: rgba(102, 255, 102, 0.2);
            border-color: #66ff66;
            color: #66ff66;
        }

        .octave-dot.locked {
            background: rgba(100, 100, 100, 0.1);
            border-color: #666;
            color: #666;
            cursor: not-allowed;
        }

        .legend {
            position: fixed;
            top: 120px;
            right: 20px;
            background: rgba(10, 10, 10, 0.9);
            border: 2px solid #00ffcc;
            border-radius: 8px;
            padding: 15px;
            backdrop-filter: blur(10px);
            font-size: 11px;
            max-width: 200px;
        }

        .legend-title {
            color: #00ffcc;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 12px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 8px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #00ffcc;
            font-size: 18px;
            text-align: center;
            text-shadow: 0 0 20px #00ffcc;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 255, 204, 0.3);
            border-top: 3px solid #00ffcc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <canvas id="canvas"></canvas>

    <div class="ui-container">
        <div class="header">
            <div class="title">ðŸ§¬ Octave Helix Spiral</div>
            <div class="controls">
                <div class="control-group">
                    <label class="control-label">Face</label>
                    <select id="faceSelect">
                        <option value="">Loading faces...</option>
                    </select>
                </div>
                <button id="resetCameraBtn">Reset Camera</button>
                <button id="pausePlayBtn">Pause Animation</button>
                <button id="toggleLabelsBtn">Toggle Labels</button>
            </div>
        </div>
    </div>

    <div class="octave-indicator">
        <div class="octave-label">Octave Progression</div>
        <div class="octave-circles" id="octaveIndicator"></div>
    </div>

    <div class="legend">
        <div class="legend-title">Elements</div>
        <div class="legend-item">
            <div class="legend-color" style="background: #8b6914;"></div>
            <span>Earth - Stability</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #0088ff;"></div>
            <span>Water - Flow</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ff4400;"></div>
            <span>Fire - Energy</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #ccccff;"></div>
            <span>Air - Clarity</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #aa00ff;"></div>
            <span>Ether - Purpose</span>
        </div>
        <hr style="margin: 10px 0; border: none; border-top: 1px solid #444;">
        <div style="margin-top: 10px;">
            <strong>Coherence:</strong>
            <div class="legend-item">
                <div class="legend-color" style="background: #00ff66;"></div>
                <span>High (80%+)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ffff00;"></div>
                <span>Good (60-80%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff9900;"></div>
                <span>Fair (40-60%)</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: #ff3333;"></div>
                <span>Low (&lt;40%)</span>
            </div>
        </div>
    </div>

    <div class="info-panel">
        <div class="info-title" id="infoTitle">ðŸ§¬ Helix Info</div>
        <div class="info-item">
            <span class="info-label">Face:</span>
            <span class="info-value" id="infoFace">â€”</span>
        </div>
        <div class="info-item">
            <span class="info-label">Current Octave:</span>
            <span class="info-value" id="infoOctave">â€”</span>
        </div>
        <div class="info-item">
            <span class="info-label">Ball Coherence:</span>
            <span class="info-value" id="infoBallCoherence">â€”</span>
        </div>
        <div class="info-item">
            <span class="info-label">Avg Pillar Health:</span>
            <span class="info-value" id="infoPillarHealth">â€”</span>
        </div>
        <div class="info-item">
            <span class="info-label">FPS:</span>
            <span class="info-value" id="infoFPS">â€”</span>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div>Initializing Helix Spiral...</div>
    </div>
<script src="https://unpkg.com/three@0.128.0/build/three.js"></script>
<script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script>
        const API_BASE = 'http://localhost:3001/api';

        // Initialize Three.js scene
        const canvas = document.getElementById('canvas');
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0x0a0a0a);
        scene.fog = new THREE.Fog(0x0a0a0a, 50, 100);

        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.set(6, 4, 6);

        const renderer = new THREE.WebGLRenderer({ canvas, antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);

        // Lighting
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
        const pointLight1 = new THREE.PointLight(0xffffff, 0.8);
        const pointLight2 = new THREE.PointLight(0x00ffcc, 0.5);
        pointLight1.position.set(10, 10, 10);
        pointLight2.position.set(-10, -5, -10);
        scene.add(ambientLight, pointLight1, pointLight2);

        // Controls - use THREE.OrbitControls since it's now a global
        const controls = new THREE.OrbitControls(camera, renderer.domElement);
        controls.enableDamping = true;
        controls.dampingFactor = 0.05;
        controls.autoRotate = true;
        controls.autoRotateSpeed = 1;

        let helixGroup = null;
        let currentFaceData = null;
        let animationRunning = true;
        let showLabels = true;
        let facesList = [];

        // Load initial data
        async function loadFacesList() {
            try {
                const response = await fetch(`${API_BASE}/faces`);
                const result = await response.json();
                if (result.success) {
                    facesList = result.data;
                    populateFaceSelect();
                    if (facesList.length > 0) {
                        await loadFaceHelix(facesList[0].id);
                    }
                }
            } catch (error) {
                console.error('Failed to load faces:', error);
            }
        }

        function populateFaceSelect() {
            const select = document.getElementById('faceSelect');
            select.innerHTML = facesList.map(face => 
                `<option value="${face.id}">${face.name}</option>`
            ).join('');
        }

        async function loadFaceHelix(faceId) {
            try {
                const response = await fetch(`${API_BASE}/octave-helix/${faceId}`);
                const result = await response.json();
                if (result.success) {
                    currentFaceData = result.data;
                    renderHelix(currentFaceData);
                    updateInfoPanel();
                    updateOctaveIndicator();
                }
            } catch (error) {
                console.error('Failed to load helix data:', error);
            }
        }

        function renderHelix(faceData) {
            // Remove old helix
            if (helixGroup) {
                scene.remove(helixGroup);
            }

            helixGroup = new THREE.Group();

            // Render ball helix
            if (faceData.ballHelix) {
                const ballMesh = createTubeGeometry(
                    faceData.ballHelix.points,
                    faceData.ballHelix.colors,
                    faceData.ballHelix.radius
                );
                helixGroup.add(ballMesh);
            }

            // Render pillar helices
            if (faceData.pillarHelices) {
                faceData.pillarHelices.forEach((pillarHelix, index) => {
                    const pillarMesh = createTubeGeometry(
                        pillarHelix.points,
                        pillarHelix.colors,
                        pillarHelix.radius
                    );
                    helixGroup.add(pillarMesh);
                });
            }

            // Add octave markers
            addOctaveMarkers(faceData.currentOctave);

            scene.add(helixGroup);
        }

        function createTubeGeometry(points, colors, radius) {
            const curve = new THREE.CatmullRomCurve3(
                points.map(p => new THREE.Vector3(p.x, p.y, p.z))
            );

            const tubeGeometry = new THREE.TubeGeometry(curve, points.length - 1, 8, 8, false);

            // Create gradient material
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = colors.length;
            canvas.height = 1;

            colors.forEach((color, i) => {
                ctx.fillStyle = `#${color.hex.toString(16).padStart(6, '0')}`;
                ctx.fillRect(i, 0, 1, 1);
            });

            const texture = new THREE.CanvasTexture(canvas);
            const material = new THREE.MeshPhongMaterial({
                map: texture,
                emissive: 0x00ffcc,
                emissiveIntensity: 0.3,
                shininess: 100
            });

            return new THREE.Mesh(tubeGeometry, material);
        }

        function addOctaveMarkers(currentOctave) {
            const octaves = [
                { id: 1, name: 'Survival', color: 0xff3333 },
                { id: 2, name: 'Structure', color: 0xff9900 },
                { id: 3, name: 'Relationships', color: 0xffff00 },
                { id: 4, name: 'Creativity', color: 0x00ff66 },
                { id: 5, name: 'Expression', color: 0x00ffcc },
                { id: 6, name: 'Vision', color: 0x00ccff },
                { id: 7, name: 'Radiance', color: 0xaa00ff }
            ];

            octaves.forEach(octave => {
                const t = octave.id / 7;
                const x = 2 * Math.cos(2 * Math.PI * 3.5 * t);
                const y = 2 * Math.sin(2 * Math.PI * 3.5 * t);
                const z = 7 * t;

                const geometry = new THREE.SphereGeometry(0.15, 16, 16);
                const material = new THREE.MeshBasicMaterial({
                    color: octave.color,
                    emissive: octave.color,
                    emissiveIntensity: octave.id <= currentOctave ? 1 : 0.3
                });
                const sphere = new THREE.Mesh(geometry, material);
                sphere.position.set(x, y, z);

                if (showLabels) {
                    const canvas = document.createElement('canvas');
                    canvas.width = 64;
                    canvas.height = 64;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = `#${octave.color.toString(16).padStart(6, '0')}`;
                    ctx.font = 'bold 40px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(octave.id, 32, 32);

                    const texture = new THREE.CanvasTexture(canvas);
                    const spriteMaterial = new THREE.SpriteMaterial({ map: texture });
                    const sprite = new THREE.Sprite(spriteMaterial);
                    sprite.position.set(x, y + 0.3, z);
                    sprite.scale.set(0.5, 0.5, 1);

                    helixGroup.add(sprite);
                }

                helixGroup.add(sphere);
            });
        }

        function updateInfoPanel() {
            if (!currentFaceData) return;

            const ballHelix = currentFaceData.ballHelix;
            const pillarHelices = currentFaceData.pillarHelices;

            const avgBallCoherence = ballHelix.coherenceData.length > 0
                ? (ballHelix.coherenceData.reduce((sum, d) => sum + d.value, 0) / ballHelix.coherenceData.length * 100).toFixed(1)
                : 0;

            const avgPillarCoherence = pillarHelices
                .reduce((sum, h) => sum + (h.coherenceData.reduce((s, d) => s + d.value, 0) / h.coherenceData.length), 0)
                / pillarHelices.length * 100;

            document.getElementById('infoFace').textContent = currentFaceData.faceName;
            document.getElementById('infoOctave').textContent = `O${currentFaceData.currentOctave}`;
            document.getElementById('infoBallCoherence').textContent = avgBallCoherence + '%';
            document.getElementById('infoPillarHealth').textContent = avgPillarCoherence.toFixed(1) + '%';
        }

        function updateOctaveIndicator() {
            const indicator = document.getElementById('octaveIndicator');
            const html = [1, 2, 3, 4, 5, 6, 7].map(i => {
                let className = 'octave-dot';
                if (i < currentFaceData.currentOctave) className += ' completed';
                else if (i === currentFaceData.currentOctave) className += ' active';
                else className += ' locked';

                return `<div class="${className}" data-octave="${i}">${i}</div>`;
            }).join('');

            indicator.innerHTML = html;
        }

        // Event listeners
        document.getElementById('faceSelect').addEventListener('change', (e) => {
            loadFaceHelix(parseInt(e.target.value));
        });

        document.getElementById('resetCameraBtn').addEventListener('click', () => {
            camera.position.set(6, 4, 6);
            controls.target.set(0, 3.5, 0);
            controls.update();
        });

        document.getElementById('pausePlayBtn').addEventListener('click', (e) => {
            animationRunning = !animationRunning;
            controls.autoRotate = animationRunning;
            e.target.textContent = animationRunning ? 'Pause Animation' : 'Play Animation';
        });

        document.getElementById('toggleLabelsBtn').addEventListener('click', (e) => {
            showLabels = !showLabels;
            if (currentFaceData) {
                renderHelix(currentFaceData);
            }
            e.target.textContent = showLabels ? 'Hide Labels' : 'Show Labels';
        });

        // Animation loop
        let lastTime = Date.now();
        let frameCount = 0;

        function animate() {
            requestAnimationFrame(animate);

            if (animationRunning) {
                controls.update();
            }

            renderer.render(scene, camera);

            // Update FPS
            frameCount++;
            const now = Date.now();
            if (now - lastTime >= 1000) {
                document.getElementById('infoFPS').textContent = frameCount;
                frameCount = 0;
                lastTime = now;
            }
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initialize
        async function init() {
            await loadFacesList();
            document.getElementById('loading').style.display = 'none';
            animate();
        }

        init();
    </script>
</body>
</html>
