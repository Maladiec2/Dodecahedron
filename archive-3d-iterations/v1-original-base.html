<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Dodecahedron - Organizational Geometry</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #000000; /* Pure black to match DNA helix view */
            color: #fff;
            overflow: hidden;
            height: 100vh;
        }

        /* Header (hides when in iframe) */
        .page-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            padding: 20px 30px;
            backdrop-filter: blur(20px);
            background: rgba(0, 0, 0, 0.8);
            border-bottom: 1px solid rgba(0, 255, 204, 0.3);
        }

        .page-header.hidden {
            display: none;
        }

        .page-title {
            font-size: 24px;
            font-weight: 300;
            letter-spacing: 2px;
            color: #00ffcc;
        }

        .page-subtitle {
            font-size: 12px;
            opacity: 0.7;
            margin-top: 5px;
            letter-spacing: 1px;
        }

        /* Canvas Container */
        #canvas-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        #scene {
            width: 100%;
            height: 100%;
        }

        /* Controls Panel */
        .controls-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 280px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid rgba(0, 255, 204, 0.3);
            border-radius: 12px;
            padding: 20px;
            backdrop-filter: blur(10px);
            z-index: 200;
            max-height: 90vh;
            overflow-y: auto;
        }

        .controls-panel h3 {
            font-size: 14px;
            font-weight: 600;
            letter-spacing: 2px;
            color: #00ffcc;
            margin-bottom: 15px;
            text-transform: uppercase;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-label {
            font-size: 11px;
            opacity: 0.7;
            margin-bottom: 8px;
            display: block;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .control-button {
            width: 100%;
            padding: 10px;
            background: rgba(0, 255, 204, 0.1);
            border: 1px solid rgba(0, 255, 204, 0.3);
            border-radius: 6px;
            color: #00ffcc;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-family: inherit;
            margin-bottom: 8px;
        }

        .control-button:hover {
            background: rgba(0, 255, 204, 0.2);
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.3);
        }

        .control-button.active {
            background: rgba(0, 255, 204, 0.3);
            border-color: #00ffcc;
        }

        .stats-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            font-size: 12px;
        }

        .stats-label {
            opacity: 0.7;
        }

        .stats-value {
            color: #00ffcc;
            font-weight: 600;
        }

        /* Face Detail Panel */
        .face-detail-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.9);
            width: 500px;
            max-width: 90vw;
            max-height: 80vh;
            background: rgba(0, 0, 0, 0.95);
            border: 2px solid rgba(0, 255, 204, 0.5);
            border-radius: 16px;
            padding: 30px;
            backdrop-filter: blur(20px);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 255, 204, 0.3);
        }

        .face-detail-panel.visible {
            opacity: 1;
            pointer-events: all;
            transform: translate(-50%, -50%) scale(1);
        }

        .face-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .face-detail-title {
            font-size: 20px;
            font-weight: 600;
            color: #00ffcc;
            letter-spacing: 1px;
        }

        .face-detail-close {
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .face-detail-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: #fff;
        }

        .face-energy-display {
            font-size: 48px;
            font-weight: 300;
            text-align: center;
            margin: 20px 0;
            color: #00ffcc;
        }

        .face-energy-label {
            text-align: center;
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 30px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .kpi-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 12px;
            margin-bottom: 20px;
        }

        .kpi-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px;
        }

        .kpi-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .kpi-name {
            font-size: 12px;
            font-weight: 500;
            opacity: 0.9;
        }

        .kpi-element {
            font-size: 10px;
            padding: 3px 8px;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Business dimension badges - professional color scheme */
        .kpi-element.earth { background: rgba(120, 120, 120, 0.3); color: #999; } /* Stability - Gray */
        .kpi-element.water { background: rgba(30, 144, 255, 0.3); color: #4a9eff; } /* Adaptability - Blue */
        .kpi-element.fire { background: rgba(255, 120, 0, 0.3); color: #ff9944; } /* Drive - Orange */
        .kpi-element.air { background: rgba(0, 200, 150, 0.3); color: #00d9a3; } /* Communication - Teal */
        .kpi-element.ether { background: rgba(100, 100, 200, 0.3); color: #8888dd; } /* Vision - Purple */

        .kpi-value-bar {
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .kpi-value-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.5s ease;
        }

        .kpi-value-fill.healthy { background: linear-gradient(90deg, #00ff88, #00ffcc); }
        .kpi-value-fill.warning { background: linear-gradient(90deg, #ffa500, #ffcc00); }
        .kpi-value-fill.critical { background: linear-gradient(90deg, #ff4444, #ff6b6b); }

        .pentagram-button {
            width: 100%;
            padding: 12px;
            background: linear-gradient(135deg, rgba(80, 80, 120, 0.2), rgba(0, 180, 180, 0.2));
            border: 1px solid rgba(0, 180, 180, 0.5);
            border-radius: 8px;
            color: #fff;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .pentagram-button:hover {
            background: linear-gradient(135deg, rgba(80, 80, 120, 0.3), rgba(0, 180, 180, 0.3));
            box-shadow: 0 0 20px rgba(0, 180, 180, 0.3);
        }

        /* Legend */
        .legend {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid rgba(0, 255, 204, 0.3);
            border-radius: 12px;
            padding: 15px;
            backdrop-filter: blur(10px);
            z-index: 200;
        }

        .legend-title {
            font-size: 12px;
            font-weight: 600;
            margin-bottom: 10px;
            color: #00ffcc;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            font-size: 11px;
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 10px;
        }

        /* Loading */
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 500;
        }

        .loading-text {
            font-size: 16px;
            color: #00ffcc;
            margin-bottom: 10px;
            letter-spacing: 2px;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 3px solid rgba(0, 255, 204, 0.2);
            border-top-color: #00ffcc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 204, 0.3);
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 204, 0.5);
        }

        /* Tooltip */
        .face-tooltip {
            position: fixed;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid rgba(0, 255, 204, 0.5);
            border-radius: 8px;
            padding: 12px 16px;
            backdrop-filter: blur(10px);
            z-index: 1500;
            opacity: 0;
            transition: opacity 0.2s ease;
            box-shadow: 0 4px 20px rgba(0, 255, 204, 0.3);
        }

        .face-tooltip.visible {
            opacity: 1;
        }

        .tooltip-face-name {
            font-size: 14px;
            font-weight: 600;
            color: #00ffcc;
            margin-bottom: 4px;
            letter-spacing: 0.5px;
        }

        .tooltip-energy {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }

        .tooltip-energy-value {
            font-weight: 600;
            margin-left: 4px;
        }

        .tooltip-energy-value.healthy {
            color: #00ff88;
        }

        .tooltip-energy-value.warning {
            color: #ffcc00;
        }

        .tooltip-energy-value.critical {
            color: #ff4444;
        }

        .tooltip-hint {
            font-size: 10px;
            color: rgba(255, 255, 255, 0.5);
            margin-top: 6px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <!-- Header (auto-hides in iframe) -->
    <div class="page-header" id="pageHeader">
        <div class="page-title">üî∑ 3D Dodecahedron</div>
        <div class="page-subtitle">Interactive Organizational Geometry</div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading">
        <div class="loading-text">INITIALIZING GEOMETRY</div>
        <div class="loading-spinner"></div>
    </div>

    <!-- Canvas -->
    <div id="canvas-container">
        <canvas id="scene"></canvas>
    </div>

    <!-- Controls Panel -->
    <div class="controls-panel">
        <h3>Controls</h3>

        <div class="control-group">
            <label class="control-label">Rotation</label>
            <button class="control-button" id="toggleRotation">Auto-Rotate: OFF</button>
        </div>

        <div class="control-group">
            <label class="control-label">Company</label>
            <button class="control-button" id="companyQuannex">Quannex</button>
            <button class="control-button" id="companyNova">Nova Tech</button>
            <button class="control-button" id="companyZenith">Zenith Solutions</button>
            <button class="control-button" id="companyApex">Apex Industries</button>
        </div>

        <div class="control-group">
            <label class="control-label">Global Stats</label>
            <div class="stats-item">
                <span class="stats-label">Coherence</span>
                <span class="stats-value" id="statCoherence">--</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">Status</span>
                <span class="stats-value" id="statStatus">--</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">Faces</span>
                <span class="stats-value">12</span>
            </div>
            <div class="stats-item">
                <span class="stats-label">Edges</span>
                <span class="stats-value">30</span>
            </div>
        </div>

        <div class="control-group">
            <label class="control-label">Instructions</label>
            <div style="font-size: 11px; opacity: 0.7; line-height: 1.6;">
                ‚Ä¢ <strong>Hover</strong> over faces for info<br>
                ‚Ä¢ <strong>Click</strong> faces for details<br>
                ‚Ä¢ <strong>Drag</strong> to rotate manually<br>
                ‚Ä¢ <strong>Scroll</strong> to zoom in/out<br>
                ‚Ä¢ <strong>R</strong> - Reset camera view<br>
                ‚Ä¢ <strong>Space</strong> - Toggle rotation<br>
                ‚Ä¢ <strong>ESC</strong> - Close panels
            </div>
        </div>
    </div>

    <!-- Legend -->
    <div class="legend">
        <div class="legend-title">Face Energy</div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #00ff88, #00ffcc);"></div>
            <span>Healthy (70-100%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #ffa500, #ffcc00);"></div>
            <span>Warning (40-70%)</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: linear-gradient(135deg, #ff4444, #ff6b6b);"></div>
            <span>Critical (0-40%)</span>
        </div>
    </div>

    <!-- Face Detail Panel -->
    <div class="face-detail-panel" id="faceDetailPanel">
        <div class="face-detail-header">
            <div class="face-detail-title" id="faceDetailTitle">Face Name</div>
            <button class="face-detail-close" id="closeFaceDetail">&times;</button>
        </div>

        <div class="face-energy-display" id="faceEnergyDisplay">--</div>
        <div class="face-energy-label">FACE ENERGY</div>

        <div class="kpi-grid" id="kpiGrid">
            <!-- KPIs will be injected here -->
        </div>

        <button class="pentagram-button" id="showPentagram">üìä Dimensional Analysis</button>
    </div>

    <!-- Hover Tooltip -->
    <div class="face-tooltip" id="faceTooltip">
        <div class="tooltip-face-name" id="tooltipFaceName">Face Name</div>
        <div class="tooltip-energy">
            Energy: <span class="tooltip-energy-value" id="tooltipEnergyValue">--</span>
        </div>
        <div class="tooltip-hint">Click to view details</div>
    </div>

    <!-- Three.js Library -->
    <script src="https://unpkg.com/three@0.128.0/build/three.js"></script>
    <script src="https://unpkg.com/three@0.128.0/examples/js/controls/OrbitControls.js"></script>

    <!-- Load breath analyzer first (as regular script, not module) -->
    <script src="js/breath-analyzer.js"></script>

    <!-- Main Quannex Engine (modules) -->
    <script type="module" src="js/main.js"></script>
    <script type="module" src="js/company-loader.js"></script>

    <!-- Dodecahedron Visualization -->
    <script src="js/dodecahedron-viz.js"></script>

    <script>
        // ============================================
        // PARENT-CHILD COMMUNICATION
        // ============================================
        // Track currently loaded company to prevent double-loading
        let currentLoadedCompanyId = null;

        /**
         * Listen for company data from parent window (when embedded in iframe)
         */
        window.addEventListener('message', async (event) => {
            const { type, companyId } = event.data;

            if (type === 'LOAD_COMPANY') {
                console.log(`[3D View] üì® Received company load request from parent: ${companyId}`);

                // Check if this company is already loaded
                if (currentLoadedCompanyId === companyId) {
                    console.log(`[3D View] ‚ÑπÔ∏è Company "${companyId}" is already loaded, skipping duplicate load`);
                    return;
                }

                try {
                    // Show loading
                    const loading = document.getElementById('loading');
                    if (loading) loading.style.display = 'block';

                    // Load the specified company using CompanyLoader
                    if (companyId && window.CompanyLoader) {
                        console.log(`[3D View] üîÑ Loading company: ${companyId}`);
                        const company = await window.CompanyLoader.loadCompany(companyId);

                        // Initialize Quannex engine with company data
                        if (window.Quannex) {
                            await window.Quannex.initWithCompany(company);
                        }

                        // Update the visualization (this will be handled by dodecahedron-viz.js)
                        // The viz script should expose a reinitialize or updateData function
                        if (window.refreshVisualization) {
                            window.refreshVisualization();
                        }

                        // Mark as loaded
                        currentLoadedCompanyId = companyId;

                        // Update stats display
                        const state = window.Quannex ? window.Quannex.getState() : null;
                        if (state) {
                            const coherencePercent = (state.globalCoherence * 100).toFixed(1);
                            document.getElementById('statCoherence').textContent = coherencePercent + '%';

                            const status = state.globalCoherence >= 0.7 ? 'Healthy' :
                                         state.globalCoherence >= 0.5 ? 'Moderate' : 'Critical';
                            document.getElementById('statStatus').textContent = status;
                        }

                        // Hide loading
                        if (loading) loading.style.display = 'none';

                        console.log(`[3D View] ‚úÖ Loaded company from parent: ${company.name}`);
                    } else {
                        console.warn('[3D View] ‚ö†Ô∏è CompanyLoader not available');
                    }
                } catch (error) {
                    console.error('[3D View] ‚ùå Failed to load company from parent:', error);
                    const loading = document.getElementById('loading');
                    if (loading) loading.style.display = 'none';
                }
            }
        });

        /**
         * Check sessionStorage for company ID (fallback mechanism)
         */
        async function checkSessionStorage() {
            // Check for custom data from orchestrator
            const selectedCompanyId = sessionStorage.getItem('selectedCompanyId');
            const customDataJson = sessionStorage.getItem('customCompanyData');

            if (selectedCompanyId === 'custom' && customDataJson) {
                try {
                    console.log(`[3D View] üé® Loading CUSTOM data from orchestrator`);
                    const customData = JSON.parse(customDataJson);

                    // Show loading
                    const loading = document.getElementById('loading');
                    if (loading) loading.style.display = 'block';

                    // Transform custom data to company format
                    const company = {
                        id: 'custom',
                        name: customData.name || 'Custom Analysis',
                        description: customData.description || 'User-generated data',
                        kpis: customData.kpis || [],
                        faceConfig: customData.faceConfig || null // üîß FIX: Pass custom face configuration
                    };

                    console.log(`[3D View] üìä Custom company has ${company.kpis.length} KPIs`);
                    if (company.faceConfig) {
                        console.log(`[3D View] üìê Using custom face configuration: ${company.faceConfig.templateName || 'Custom'}`);
                        console.log(`[3D View] üìù Custom faces:`, company.faceConfig.faces.map(f => f.name));
                    } else {
                        console.log(`[3D View] ‚ö†Ô∏è No face configuration found - will use defaults`);
                    }

                    // Wait for dependencies to load
                    let attempts = 0;
                    while (!window.Quannex && attempts < 10) {
                        await new Promise(resolve => setTimeout(resolve, 200));
                        attempts++;
                    }

                    // Initialize Quannex with custom data
                    if (window.Quannex) {
                        await window.Quannex.initWithCompany(company);

                        // Update visualization if function exists
                        if (window.refreshVisualization) {
                            window.refreshVisualization();
                        }

                        // Update stats
                        const state = window.Quannex.getState();
                        if (state) {
                            const coherencePercent = (state.globalCoherence * 100).toFixed(1);
                            document.getElementById('statCoherence').textContent = coherencePercent + '%';

                            const status = state.globalCoherence >= 0.7 ? 'Healthy' :
                                         state.globalCoherence >= 0.5 ? 'Moderate' : 'Critical';
                            document.getElementById('statStatus').textContent = status;
                        }

                        // Hide company selector buttons since this is custom data
                        const companyButtons = document.querySelectorAll('.control-group button[id^="company"]');
                        if (companyButtons.length > 0) {
                            companyButtons.forEach(btn => btn.style.display = 'none');
                        }
                        const companyLabel = document.querySelector('.control-group .control-label');
                        if (companyLabel && companyLabel.textContent === 'Company') {
                            companyLabel.textContent = 'Custom Analysis';
                        }
                    }

                    // Mark as loaded
                    currentLoadedCompanyId = 'custom';

                    // Hide loading
                    if (loading) loading.style.display = 'none';

                    console.log(`[3D View] ‚úÖ Successfully loaded custom data`);
                    return true;
                } catch (error) {
                    console.error('[3D View] ‚ùå Failed to load custom data:', error);
                }
            } else if (window.self !== window.top && selectedCompanyId) {
                // Running in iframe with regular company
                if (selectedCompanyId && !currentLoadedCompanyId) {
                    console.log(`[3D View] üíæ Found company ID in sessionStorage: ${selectedCompanyId}`);
                    // Trigger load via postMessage handler
                    window.postMessage({ type: 'LOAD_COMPANY', companyId: selectedCompanyId }, '*');
                }
            }
        }

        // Check for company in sessionStorage after a short delay (allow scripts to load)
        setTimeout(checkSessionStorage, 1000);

        // üîß FIX: Poll sessionStorage for updates (when user recalculates in orchestrator)
        let lastKnownTimestamp = null;

        function checkForUpdates() {
            const customDataJson = sessionStorage.getItem('customCompanyData');
            if (!customDataJson) return;

            try {
                const customData = JSON.parse(customDataJson);
                const newTimestamp = customData.timestamp;

                // If timestamp changed, data was updated - reload!
                if (lastKnownTimestamp && newTimestamp !== lastKnownTimestamp) {
                    console.log('[3D View] üîÑ Detected data update! Reloading...');
                    console.log('   Old timestamp:', lastKnownTimestamp);
                    console.log('   New timestamp:', newTimestamp);

                    // Reload the visualization
                    checkSessionStorage();
                }

                lastKnownTimestamp = newTimestamp;
            } catch (error) {
                console.error('[3D View] ‚ùå Error checking for updates:', error);
            }
        }

        // Check for updates when user switches back to this tab
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                console.log('[3D View] üëÄ Tab became visible - checking for updates...');
                checkForUpdates();
            }
        });

        // Also poll every 2 seconds (lightweight check)
        setInterval(checkForUpdates, 2000);

        console.log('[3D View] üì° Message listener initialized');
        console.log('[3D View] üîÑ Auto-refresh enabled - will detect recalculations');
    </script>
</body>
</html>
